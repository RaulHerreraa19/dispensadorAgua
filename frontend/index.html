<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Dispensador</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --fondo: #f6f7fb;
        --panel: #ffffff;
        --borde: #e5e7eb;
        --texto: #0f172a;
        --muted: #6b7280;
        --verde: #16a34a;
        --verde-oscuro: #15803d;
        --azul-suave: #e0f2fe;
        --sombra: 0 12px 35px rgba(15, 23, 42, 0.08);
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Manrope", system-ui, -apple-system, sans-serif;
        background: radial-gradient(circle at 20% 20%, #eef2ff, transparent 30%),
          radial-gradient(circle at 80% 0%, #e0f2fe, transparent 25%),
          var(--fondo);
        color: var(--texto);
        margin: 0;
        padding: 0;
      }
      header {
        padding: 20px 28px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        backdrop-filter: blur(10px);
        position: sticky;
        top: 0;
      }
      h1 {
        margin: 0;
        font-size: 24px;
        font-weight: 700;
      }
      .chip {
        background: var(--azul-suave);
        color: #0ea5e9;
        padding: 8px 12px;
        border-radius: 999px;
        font-weight: 600;
      }
      main {
        padding: 0 28px 28px;
        display: grid;
        gap: 18px;
        grid-template-columns: 2fr 3fr;
        align-items: start;
      }
      .panel {
        background: var(--panel);
        border: 1px solid var(--borde);
        border-radius: 16px;
        padding: 18px;
        box-shadow: var(--sombra);
      }
      .panel h2 {
        margin: 0 0 12px 0;
        font-size: 18px;
      }
      .fila {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }
      label {
        color: var(--muted);
        font-weight: 600;
      }
      button {
        background: var(--verde);
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 12px 18px;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.1s ease, box-shadow 0.1s ease,
          background 0.2s ease;
        box-shadow: 0 10px 30px rgba(22, 163, 74, 0.25);
      }
      button:hover {
        background: var(--verde-oscuro);
        transform: translateY(-1px);
      }
      select {
        padding: 10px;
        border-radius: 10px;
        border: 1px solid var(--borde);
        background: #f9fafb;
        color: var(--texto);
        font-weight: 600;
      }
      .estado {
        color: var(--muted);
        font-size: 14px;
      }
      .feed {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 520px;
        overflow-y: auto;
        display: grid;
        gap: 10px;
      }
      .evento {
        padding: 12px;
        border: 1px solid var(--borde);
        border-radius: 12px;
        background: #fdfefe;
        box-shadow: inset 0 1px 0 #fff;
      }
      .tag {
        display: inline-block;
        padding: 6px 10px;
        border-radius: 999px;
        background: #ecfeff;
        color: #0ea5e9;
        margin-right: 8px;
        font-size: 12px;
        font-weight: 700;
      }
      .mini {
        color: var(--muted);
        font-size: 12px;
      }
      .origen {
        font-weight: 700;
        color: #111827;
      }
      .tabla-wrapper {
        overflow-x: auto;
      }
      .tabla {
        width: 100%;
        border-collapse: collapse;
      }
      .tabla th,
      .tabla td {
        text-align: left;
        padding: 10px;
        border-bottom: 1px solid var(--borde);
      }
      .tabla th {
        background: #f8fafc;
        color: var(--muted);
        font-size: 13px;
      }
      .tabla td code {
        background: #f1f5f9;
        padding: 4px 6px;
        border-radius: 6px;
        font-size: 12px;
        display: inline-block;
      }
      .alerta {
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: #16a34a;
        color: #fff;
        padding: 12px 16px;
        border-radius: 12px;
        box-shadow: 0 14px 30px rgba(22, 163, 74, 0.35);
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.2s ease, transform 0.2s ease;
      }
      .alerta-visible {
        opacity: 1;
        transform: translateY(0);
      }
      @media (max-width: 960px) {
        main {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Dispensador en tiempo real</h1>
      <span class="chip" id="estadoWs">WS: desconectado</span>
    </header>
    <main>
      <section class="panel">
        <h2>Control r√°pido</h2>
        <div class="fila">
          <label for="selectVaso">Selecciona vaso</label>
          <select id="selectVaso">
            <option value="1">Vaso 1</option>
            <option value="2">Vaso 2</option>
            <option value="3">Vaso 3</option>
          </select>
          <button id="btnDispensar">Dispensar vaso</button>
        </div>
        <p class="estado" id="estadoHttp">Sincronizando eventos iniciales...</p>
      </section>

      <section class="panel">
        <h2>Comandos enviados</h2>
        <ul id="listaComandos" class="feed"></ul>
      </section>

      <section class="panel" style="grid-column: 1 / -1">
        <h2>Eventos guardados (BD)</h2>
        <div class="tabla-wrapper">
          <table class="tabla">
            <thead>
              <tr>
                <th>Tipo</th>
                <th>Origen</th>
                <th>Fecha</th>
                <th>Datos</th>
              </tr>
            </thead>
            <tbody id="cuerpoTablaEventos"></tbody>
          </table>
        </div>
      </section>
    </main>

    <div id="alerta" class="alerta" hidden>Enviado</div>

    <script>
      const backendHost = window.location.hostname || "localhost";
      const httpBase = `http://${backendHost}:3000`;
      const wsUrl = `ws://${backendHost}:8080`;
      const listaComandos = document.getElementById("listaComandos");
      const cuerpoTablaEventos = document.getElementById("cuerpoTablaEventos");
      const estadoWs = document.getElementById("estadoWs");
      const estadoHttp = document.getElementById("estadoHttp");
      const btnDispensar = document.getElementById("btnDispensar");
      const selectVaso = document.getElementById("selectVaso");

      function pintarComando(enviado) {
        const item = document.createElement("li");
        item.className = "evento";
        const fecha = new Date().toLocaleString();
        item.innerHTML = `
          <span class="tag">comando</span>
          <span class="mini">${fecha}</span><br />
          <span class="origen">Destino: MQTT</span><br />
          <span class="mini">${JSON.stringify(enviado)}</span>
        `;
        listaComandos.prepend(item);
      }

      function pintarEventoTabla(evento) {
        const fila = document.createElement("tr");
        const fecha = evento.creadoEn
          ? new Date(evento.creadoEn).toLocaleString()
          : new Date().toLocaleString();
        fila.innerHTML = `
          <td>${evento.tipo || "evento"}</td>
          <td>${evento.origen || "desconocido"}</td>
          <td>${fecha}</td>
          <td><code>${JSON.stringify(evento.datos)}</code></td>
        `;
        cuerpoTablaEventos.prepend(fila);
      }

      async function cargarEventosIniciales() {
        try {
          const resp = await fetch(`${httpBase}/api/events?limite=40`);
          const data = await resp.json();
          if (data && data.eventos) {
            data.eventos.reverse().forEach(pintarEventoTabla);
            estadoHttp.textContent = "Eventos sincronizados";
          }
        } catch (error) {
          estadoHttp.textContent = "No se pudieron cargar eventos iniciales";
          console.warn("No se pudieron cargar eventos iniciales", error);
        }
      }

      let socket;

      function conectarWs() {
        socket = new WebSocket(wsUrl);
        socket.onopen = () => {
          estadoWs.textContent = "WS: conectado";
          estadoWs.style.background = "#dcfce7";
          estadoWs.style.color = "#166534";
        };
        socket.onclose = () => {
          estadoWs.textContent = "WS: desconectado, reintentando...";
          estadoWs.style.background = "#fee2e2";
          estadoWs.style.color = "#991b1b";
          setTimeout(conectarWs, 2000);
        };
        socket.onerror = () => {
          estadoWs.textContent = "WS: error";
          estadoWs.style.background = "#fee2e2";
          estadoWs.style.color = "#991b1b";
        };
        socket.onmessage = (mensaje) => {
          try {
            const contenido = JSON.parse(mensaje.data);
            if (contenido.tipo === "evento" && contenido.datos) {
              pintarEventoTabla(contenido.datos);
            }
          } catch (error) {
            console.warn("Mensaje WS no reconocido", mensaje.data);
          }
        };
      }

      btnDispensar.addEventListener("click", () => {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
          alert("WebSocket no conectado");
          return;
        }
        const cuerpo = {
          tipo: "command",
          cmd: "dispense",
          cup: Number(selectVaso.value),
        };
        socket.send(JSON.stringify(cuerpo));
        pintarComando(cuerpo);
        mostrarAlerta("Comando enviado");
      });

      const alerta = document.getElementById("alerta");
      let alertaTimer;
      function mostrarAlerta(texto) {
        alerta.textContent = texto;
        alerta.hidden = false;
        alerta.classList.add("alerta-visible");
        clearTimeout(alertaTimer);
        alertaTimer = setTimeout(() => {
          alerta.classList.remove("alerta-visible");
          alerta.hidden = true;
        }, 1800);
      }

      cargarEventosIniciales();
      conectarWs();
    </script>
  </body>
</html>
